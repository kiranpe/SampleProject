pipeline {

   environment {
     DOCKER_REGISTRY='http://registry-1.docker.io'
     CONTAINER='kiranp23/apache'
     VERSION="latest"
   }

   agent any
     
    stages {
     
     stage('build docker image') {
         steps {
           script {
                docker.build("${CONTAINER}:${VERSION}")
           }
         }
     }

     stage('Check the staus') {
         steps {
           sh 'ansible-playbook ${WORKSPACE}/devserver/image-status.yml'
         }
     }
    
     stage('Copy SSH key to dev server') {
         steps {
           sh 'ansible-playbook -i ${WORKSPACE}/devserver/jenkinsci --private-key /sites/privatekey.pem ${WORKSPACE}/devserver/push-ssh-key.yml'
         }
     } 
 
     stage('Deploy on dev server') {
        steps {
         withCredentials([
             usernamePassword(
                credentialsId: 'docker-id',
                usernameVariable: 'DOCKER_USER',
                passwordVariable: 'DOCKER_PASSWORD'
             )
           ])
           {
            script {
             echo "deploying to dev server"
             sh 'ansible-playbook -i ${WORKSPACE}/devserver/jenkinsci ${WORKSPACE}/devserver/deploy-dev.yml -e "hub_user=${DOCKER_USER} hub_pass=${DOCKER_PASSWORD}"'
            }
           }
        }
     }
   }
}
